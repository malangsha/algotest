# AlgoTrading Platform - Architecture Documentation

## System Architecture Overview

The AlgoTrading platform uses a modular, event-driven architecture optimized for Indian markets (NSE/BSE). Components communicate through well-defined interfaces for flexibility and extensibility.

```
┌─────────────────┐     ┌───────────────────┐     ┌───────────────────┐
│     Web UI      │◄───►│  Core Engine      │◄───►│  Broker Adapters  │
│  (Dashboard/API)│     │ (Event Processing)│     │  (Market Access)  │
└─────────────────┘     └───────────────────┘     └───────────────────┘
        ▲                        ▲                         ▲
        │                        │                         │
        ▼                        ▼                         ▼
┌─────────────────┐     ┌───────────────────┐     ┌───────────────────┐
│  Data Storage   │     │ Strategy Modules  │     │  Risk Management  │
│  (Persistence)  │     │ (Trading Logic)   │     │  (Safety Controls)│
└─────────────────┘     └───────────────────┘     └───────────────────┘
```

### Architecture Principles

1. **Event-Driven Design**: All system components communicate through events, allowing for loose coupling
2. **Dependency Injection**: Components receive dependencies rather than creating them
3. **Domain-Driven Design**: Models reflect the trading domain language
4. **Factory Pattern**: Creates strategies and broker adapters based on configuration
5. **Observer Pattern**: Components subscribe to events they're interested in

## Core Architecture

### Event Flow
The event flow is the central nervous system of the architecture:

1. **Market Data Events**: Price ticks, order book updates, volume data
2. **Signal Events**: Generated by strategies indicating trading opportunities 
3. **Order Events**: Order creation, modification, cancellation, fills
4. **System Events**: Startup, shutdown, error conditions

Events flow through the `EventManager` which routes them to registered listeners, creating a pub/sub model.

### Core Engine

The `TradingEngine` class orchestrates the system:
- Controls the main event loop
- Manages component lifecycle
- Maintains system state
- Coordinates between components

### Modular Design

Each component has a clearly defined responsibility:
- **Market Data Manager**: Data acquisition and preprocessing
- **Strategy Manager**: Trading logic and signal generation
- **Order Manager**: Order creation and lifecycle management
- **Position Manager**: Position tracking and reconciliation
- **Risk Manager**: Risk controls and exposure limits
- **Broker Interface**: Communication with exchange/broker APIs

## Web Architecture

The web component uses **FastAPI** for performance and modern API features.

### Web Stack
```
Frontend (Browser) ←→ FastAPI Server ←→ Trading Engine
                        ↑   ↓
                     Database
```

### Web Component Breakdown

1. **FastAPI Application** (`web/app.py`):
   - Main web application entry point
   - Route definitions
   - Middleware configuration
   - CORS handling

2. **API Endpoints** (`web/api.py`):
   - RESTful endpoints using FastAPI router
   - HTTP methods mapped to trading actions
   - Pydantic models for request/response validation
   - JWT authentication

3. **WebSocket Interface** (`web/websocket.py`):
   - Real-time data streaming
   - Live updates for positions, orders, P&L
   - Connection management

4. **Dashboard UI** (`web/dashboard.py`):
   - Dashboard routes and templating
   - Chart generation
   - Interactive controls

### FastAPI Implementation

```python
# web/app.py
from fastapi import FastAPI, Depends
from fastapi.middleware.cors import CORSMiddleware
from .api import create_api_router
from .websocket import create_websocket_router
from .dashboard import create_dashboard_router

def start_web_app(config):
    app = FastAPI(title="AlgoTrading Platform")
    
    # CORS configuration
    app.add_middleware(
        CORSMiddleware,
        allow_origins=config.get("web", {}).get("cors_origins", ["*"]),
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # Include routers
    app.include_router(create_api_router(config), prefix="/api/v1")
    app.include_router(create_websocket_router(config), prefix="/ws")
    app.include_router(create_dashboard_router(config))
    
    # Start the server
    import uvicorn
    host = config.get("web", {}).get("host", "0.0.0.0")
    port = config.get("web", {}).get("port", 8000)
    uvicorn.run(app, host=host, port=port)
```

### API Integration with Trading Engine

The web component integrates with the trading engine through:

1. **Direct Reference**: The FastAPI app holds a reference to the engine instance
2. **Event Subscription**: Web components subscribe to engine events
3. **Command Dispatch**: API endpoints trigger engine commands

Example API flow:
```
POST /api/v1/orders → API Router → Engine.create_order() → Broker Adapter → Exchange
```

### WebSocket Communication

Real-time updates flow through WebSocket connections:
- Market data pushed to clients immediately
- Order status changes broadcast to subscribers
- Position updates sent when changes occur

This provides a responsive UI without constant polling.

## How to Query About Web Components

To get more information about specific web components:

1. **For API endpoints**: Ask about "web/api.py" or specific endpoints like "/api/v1/orders"
2. **For WebSocket functionality**: Ask about "web/websocket.py" or "real-time updates"
3. **For Dashboard features**: Ask about "web/dashboard.py" or specific UI components
4. **For authentication**: Ask about "web/auth.py" or "JWT implementation"

Examples:
- "Can you explain how web/api.py handles order creation?"
- "How does the WebSocket component in web/websocket.py manage multiple connections?"
- "What are the dashboard views implemented in web/dashboard.py?"

## Interaction Between Components

### Web to Core Engine Flow

When a user interacts with the web interface:

1. User action (e.g., click "Place Order") → HTTP Request
2. FastAPI endpoint receives and validates request
3. Request transformed into engine command
4. Engine processes command and creates events
5. Events propagate through system
6. Results flow back to web interface
7. UI updates via WebSocket push

### Core Engine to Web Flow

When market conditions change:

1. Market data received by engine
2. Engine processes data and updates state
3. Strategy generates signals
4. Orders created/modified
5. Positions updated
6. Events published to event bus
7. Web components receive relevant events
8. WebSocket sends updates to connected clients
9. UI refreshes with new data

This bidirectional flow ensures the web interface always reflects the current state of the trading system.


┌─────────────────┐     ┌─────────────────────┐     ┌─────────────────┐
│                 │     │                     │     │                 │
│  Market Data    │     │                     │     │  Strategy       │
│  Sources        │     │  Event Manager      │     │  Components     │
│  (Feeds)        │     │                     │     │                 │
│                 │     │                     │     │                 │
└────────┬────────┘     └─────────┬───────────┘     └────────┬────────┘
         │                        │                          │
         │                        │                          │
         ▼                        │                          │
┌────────────────┐                │                          │
│                │   Publish      │                          │
│ Market Data    ├───Events──────►│                          │
│ Feed           │                │                          │
│                │                │                          │
└────────────────┘                │       Notifies           │
                                  ├─────Subscribers─────────►│
                                  │                          │
                                  │                          │
                                  │                          │
                                  │                          │
┌────────────────┐                │                          │
│                │   Subscribe    │                          │
│ Market Data    ◄───to Events────┤                          │
│ Manager        │                │                          │
│                │                │                          │
└────────┬───────┘                │                          │
         │                        │                          │
         │                        │                          │
         │        Provide         │                          │
         └──────Market Data───────┼─────────────────────────►│
                                  │                          │

## Market Data Flow Explanation

The diagram illustrates the flow of market data through the system's event-driven architecture:

### Key Components and Their Roles

1. **Market Data Sources (Feeds)**: External data providers that supply raw market data (price ticks, order book updates, etc.)

2. **Market Data Feed**: The adapter component that:
   - Connects to external data sources
   - Normalizes raw data into the system's format
   - Publishes standardized MarketDataEvents to the Event Manager
   - Acts as the primary producer of market data in the system

3. **Event Manager**: The central message bus that:
   - Receives events from publishers
   - Routes events to appropriate subscribers
   - Maintains the pub/sub relationships
   - Ensures loose coupling between components

4. **Market Data Manager**: A specialized consumer that:
   - Subscribes to MarketDataEvents from the Event Manager
   - Stores and organizes market data
   - Provides clean, structured access to market data
   - Serves as a centralized data repository for other components

5. **Strategy Components**: The trading logic that:
   - Receives market data notifications
   - Analyzes data to generate trading signals
   - Makes trading decisions based on market conditions

### Flow Sequence

1. External market data arrives at the Market Data Feed
2. The Feed transforms and publishes this as events to the Event Manager
3. The Event Manager notifies all subscribers, including the Market Data Manager
4. The Market Data Manager stores and organizes the data
5. Strategy components access market data in two ways:
   - Directly via event notifications (for real-time processing)
   - Via the Market Data Manager (for historical/structured queries)

### Key Differences Between Market Data Feed and Market Data Manager

| Market Data Feed | Market Data Manager |
|------------------|---------------------|
| **Producer** of market data events | **Consumer** of market data events |
| Focuses on **connectivity** to external sources | Focuses on **storage and organization** |
| Handles **raw data transformation** | Handles **data retention and retrieval** |
| **Pushes** data into the system | Allows components to **pull** data as needed |
| Concerned with **real-time delivery** | Concerned with **historical context** |
| Manages **external connections** | Manages **internal data access** |

This separation of concerns allows the system to handle different data sources through a common interface while maintaining a consistent, organized repository of market data for analysis and decision-making.




┌─────────────────────────────────────────────────────────────────────────────┐
│                              LIVE TRADING ARCHITECTURE                       │
└─────────────────────────────────────────────────────────────────────────────┘
                                                                        
 ┌────────────────┐         ┌────────────────┐        ┌────────────────┐     
 │                │         │                │        │                │     
 │  LiveEngine    │◄────────┤  EventManager  │◄───────┤  TradingEngine │     
 │                │         │                │        │                │     
 └────────┬───────┘         └────────────────┘        └────────────────┘     
          │                                                    ▲              
          │                                                    │              
          ▼                                                    │              
 ┌────────────────┐         ┌────────────────┐        ┌───────┴───────┐     
 │                │         │                │        │                │     
 │  MarketDataFeed├────────►│  FinvasiaFeed  │        │  Strategies   │     
 │                │         │                │        │                │     
 └────────┬───────┘         └────────┬───────┘        └────────────────┘     
          │                          │                        ▲              
          │                          │                        │              
          ▼                          ▼                        │              
 ┌────────────────┐         ┌────────────────┐       ┌───────┴───────┐      
 │                │         │                │       │                │      
 │  FinvasiaBroker├────────►│  NorenApi      │       │  MarketData   │      
 │                │         │                │       │  Manager       │      
 └────────────────┘         └────────┬───────┘       └────────────────┘      
                                     │                       ▲               
                                     │                       │               
                                     ▼                       │               
                            ┌────────────────┐               │               
                            │                │               │               
                            │  Websocket     ├───────────────┘               
                            │  Feed          │                               
                            │                │                               
                            └────────────────┘                               
# Integrating FinvasiaFeed with LiveEngine and Configuration

I'll help you integrate the FinvasiaFeed class with LiveEngine, add persistence configuration, and provide documentation with architectural diagrams.

## 1. Integrating MarketDataFeed (FinvasiaFeed) with LiveEngine

First, let's modify the LiveEngine class to properly initialize and integrate with FinvasiaFeed:

```python:live/live_engine.py
def initialize_market_data_feed(self):
    """Initialize the market data feed."""
    # Get the instruments from the config
    instruments_config = self.config.get('instruments', [])
   
    # Convert string symbols to Instrument objects if needed        
    for instrument in self.active_instruments:
        if isinstance(instrument, str):
            # Convert string to Instrument object
            for instr_config in instruments_config:
                if instr_config.get('symbol') == instrument:
                    instrument = Instrument(
                        instrument_id=instr_config.get('id', instr_config.get('symbol')),
                        instrument_type=instr_config.get('instrument_type', InstrumentType.EQUITY),
                        symbol=instr_config['symbol'],
                        exchange=instr_config.get('exchange', ''),
                        asset_type=instr_config.get('asset_type', ''),
                        currency=instr_config.get('currency', ''),
                        tick_size=instr_config.get('tick_size', 0.01),
                        lot_size=instr_config.get('lot_size', 1.0),
                        margin_requirement=instr_config.get('margin_requirement', 1.0),
                        is_tradable=instr_config.get('is_tradable', True),
                        expiry_date=instr_config.get('expiry_date'),
                        additional_info=instr_config.get('additional_info', {})
                    )
                    self.instruments[instrument.symbol] = instrument
                    self.instrument_objects.append(instrument)
        else:
            # Already an Instrument object
            self.instrument_objects.append(instrument)

    self.logger.info(f"Creating market data feed with {len(self.instrument_objects)} instrument objects")

    # Read broker configuration from the config file
    broker_feed_type = None
    broker_market_data = None

    # Step 1: Find the broker configuration based on broker instance
    current_broker_config = None
    if hasattr(self.broker, 'broker_name') and self.config.get("broker"):
        for broker_config in self.config.get("broker", []):
            if broker_config.get("broker_name") == self.broker.broker_name:
                current_broker_config = broker_config
                break

    # Step 2: Get market_data_source from the current broker
    market_data_source = None
    if current_broker_config:
        market_data_source = current_broker_config.get("market_data_source")

    # Step 3: If market_data_source is the same as broker name, use its own market_data
    if market_data_source == getattr(self.broker, 'broker_name', None) and current_broker_config:
        broker_market_data = current_broker_config.get("market_data", {})
        broker_feed_type = broker_market_data.get("feed_type")
    
    # Step 4: Otherwise find the broker specified in market_data_source and use its market_data
    elif market_data_source and self.config.get("broker"):
        for broker_config in self.config.get("broker", []):
            if broker_config.get("broker_name") == market_data_source:
                broker_market_data = broker_config.get("market_data", {})
                broker_feed_type = broker_market_data.get("feed_type")
                break

    # Fallback to broker's feed_type attribute if configuration wasn't found
    if not broker_feed_type and hasattr(self.broker, 'feed_type'):
        broker_feed_type = self.broker.feed_type

    # Fallback to global market_data config only if broker doesn't specify        
    if not broker_feed_type:
        broker_feed_type = "simulated" # Default to simulated instead of websocket        
    
    self.logger.info(f"Broker feed type: {broker_feed_type}")

    # Create the market data feed
    data_feed = MarketDataFeed(
        feed_type=broker_feed_type,
        broker=self.broker,            
        instruments=self.instrument_objects,
        event_manager=self.event_manager
    )
    
    # Configure persistence if enabled in config
    market_data_config = self.config.get("market_data", {})
    if market_data_config.get("enable_persistence", False) and hasattr(data_feed.feed, "enable_persistence"):
        persistence_path = market_data_config.get("persistence_path", "./data/ticks")
        persistence_interval = market_data_config.get("persistence_interval", 300)
        
        self.logger.info(f"Enabling market data persistence. Path: {persistence_path}, Interval: {persistence_interval}s")
        data_feed.feed.enable_persistence(
            enabled=True,
            interval=persistence_interval,
            path=persistence_path
        )
    
    return data_feed
```

## 2. Enabling Persistence in FinvasiaFeed

The existing FinvasiaFeed class already has a method called `enable_persistence` that we can use from our configuration.

## 3. Adding Configuration to config.yaml

The configuration structure should look like this:

```yaml
broker:
  - broker_name: finvasia
    market_data:
      websocket_url: "wss://api.shoonya.com/NorenWSTP/"
      api_key: "90633ed8f1fa35e9a9cbc36defbdcd1a"
      feed_type: "finvasia_ws"
      reconnect_interval: 5
      max_reconnect_attempts: 10
      enable_persistence: true

market_data:
  enable_persistence: true
  persistence_path: "./data/ticks"
  persistence_interval: 300
  max_ticks_in_memory: 10000
```

## 4. Modifying MarketDataFeed to Handle the New Configuration

Let's update the MarketDataFeed class to handle the new configuration:

```python:live/market_data_feeds.py
def start(self):
    """Start the market data feed."""
    if self.feed:
        self.feed.start()
        return

    # Get market data settings from broker
    market_data_settings = self.broker.get_market_data_settings() if hasattr(self.broker, 'get_market_data_settings') else {}
    
    # Check if persistence is enabled at the broker or global level
    enable_persistence = market_data_settings.get('enable_persistence', False)
    persistence_path = market_data_settings.get('persistence_path', './data/ticks')
    persistence_interval = market_data_settings.get('persistence_interval', 300)

    if self.feed_type == 'websocket':
        # Create WebSocketFeed
        # [Code remains the same]
    
    elif self.feed_type == 'rest':
        # Create RestPollingFeed
        # [Code remains the same]
    
    elif self.feed_type == 'simulated':
        # Create SimulatedFeed
        # [Code remains the same]
    
    elif self.feed_type == 'finvasia_ws':
        # Get additional settings specific to Finvasia
        user_id = self.settings.get('user_id') or self.broker.user_id if hasattr(self.broker, 'user_id') else None
        password = self.settings.get('password') or self.broker.password if hasattr(self.broker, 'password') else None
        api_key = self.settings.get('api_key') or self.api_key
        imei = self.settings.get('imei') or self.broker.imei if hasattr(self.broker, 'imei') else None
        twofa = self.settings.get('twofa') or self.broker.twofa if hasattr(self.broker, 'twofa') else None
        vc = self.settings.get('vc') or self.broker.vc if hasattr(self.broker, 'vc') else None
        api_url = self.settings.get('api_url', "https://api.shoonya.com/NorenWClientTP/")
        ws_url = self.settings.get('websocket_url', "wss://api.shoonya.com/NorenWSTP/")
        
        self.feed = FinvasiaFeed(
            instruments=self.instruments,
            callback=self._handle_market_data,
            user_id=user_id,
            password=password,
            api_key=api_key,
            imei=imei,
            twofa=twofa,
            vc=vc,
            api_url=api_url,
            ws_url=ws_url,
            debug=self.settings.get('debug', False)
        )
        
        # Configure persistence if enabled
        if enable_persistence and hasattr(self.feed, 'enable_persistence'):
            self.logger.info(f"Enabling persistence for Finvasia feed. Path: {persistence_path}, Interval: {persistence_interval}s")
            self.feed.enable_persistence(
                enabled=True,
                interval=persistence_interval,
                path=persistence_path
            )
        
        # Set maximum ticks in memory if configured
        max_ticks = self.settings.get('max_ticks_in_memory', 10000)
        if hasattr(self.feed, 'set_max_ticks_in_memory'):
            self.feed.set_max_ticks_in_memory(max_ticks)
    
    else:
        raise ValueError(f"Unsupported feed type: {self.feed_type}")
    
    # Start the feed
    self.feed.start()
```

## 5. Documentation and Architectural Diagrams

### 5.1 FinvasiaFeed Class and Its Integration with Broker

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                               FINVASIA FEED ARCHITECTURE                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                                                        
 ┌───────────────────┐      ┌───────────────────┐     ┌────────────────────┐  
 │                   │      │                   │     │                    │  
 │                   │      │                   │     │                    │  
 │  FinvasiaBroker   │◄────►│   FinvasiaFeed    │─────┤  Event Manager     │  
 │                   │      │                   │     │                    │  
 │                   │      │                   │     │                    │  
 └───────┬───────────┘      └─────────┬─────────┘     └────────────────────┘  
         │                            │                         ▲              
         │                            │                         │              
         │                            ▼                         │              
 ┌───────▼───────────┐      ┌─────────────────────┐            │              
 │                   │      │                     │            │              
 │  NorenApi Client  │      │ In-Memory           │            │              
 │  (REST Client)    │      │ Tick Store          │            │              
 │                   │      │                     │            │              
 └───────┬───────────┘      └─────────┬───────────┘            │              
         │                            │                         │              
         ▼                            ▼                         │              
 ┌───────────────────┐      ┌─────────────────────┐            │              
 │                   │      │                     │            │              
 │  WebSocket        │      │ Persistence         │            │              
 │  Connection       │      │ (CSV Files)         │            │              
 │                   │      │                     │            │              
 └───────────────────┘      └─────────────────────┘            │              
         │                                                     │              
         │                                                     │              
         ▼                                                     │              
 ┌───────────────────────────────────────────────┐             │              
 │                                               │             │              
 │  MarketDataEvent Creation                     │──────────────              
 │                                               │                            
 └───────────────────────────────────────────────┘                            
```

**FinvasiaFeed Key Components**:

1. **NorenApi Client**: Connects to Finvasia's REST API for authentication and initial setup.
2. **WebSocket Connection**: Establishes real-time market data stream.
3. **In-Memory Tick Store**: Holds recent market data ticks in memory for quick access.
4. **Persistence Layer**: Periodically saves tick data to disk in CSV format.
5. **Symbol-Token Mapping**: Maintains a mapping between human-readable symbols and exchange tokens.

**Key Processes**:

1. **Authentication Flow**:
   - Login with user credentials (user ID, password, 2FA if enabled)
   - Obtain session token
   - Initialize WebSocket with the token

2. **Market Data Flow**:
   - Subscribe to symbols using token IDs
   - Receive tick data via WebSocket
   - Convert ticks to standardized MarketDataEvent format
   - Store in memory and periodically persist to disk
   - Publish events to the Event Manager

3. **Symbol Management**:
   - Cache symbol-to-token mappings
   - Auto-fetch missing tokens on demand
   - Periodically refresh the symbol cache

### 5.2 LiveEngine, MarketDataFeed, and FinvasiaFeed Interactions


┌─────────────────────────────────────────────────────────────────────────────┐
│                               FINVASIA FEED ARCHITECTURE                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                                                        
 ┌───────────────────┐      ┌───────────────────┐     ┌────────────────────┐  
 │                   │      │                   │     │                    │  
 │                   │      │                   │     │                    │  
 │  FinvasiaBroker   │◄────►│   FinvasiaFeed    │─────┤  Event Manager     │  
 │                   │      │                   │     │                    │  
 │                   │      │                   │     │                    │  
 └───────┬───────────┘      └─────────┬─────────┘     └────────────────────┘  
         │                            │                         ▲              
         │                            │                         │              
         │                            ▼                         │              
 ┌───────▼───────────┐      ┌─────────────────────┐            │              
 │                   │      │                     │            │              
 │  NorenApi Client  │      │ In-Memory           │            │              
 │  (REST Client)    │      │ Tick Store          │            │              
 │                   │      │                     │            │              
 └───────┬───────────┘      └─────────┬───────────┘            │              
         │                            │                         │              
         ▼                            ▼                         │              
 ┌───────────────────┐      ┌─────────────────────┐            │              
 │                   │      │                     │            │              
 │  WebSocket        │      │ Persistence         │            │              
 │  Connection       │      │ (CSV Files)         │            │              
 │                   │      │                     │            │              
 └───────────────────┘      └─────────────────────┘            │              
         │                                                     │              
         │                                                     │              
         ▼                                                     │              
 ┌───────────────────────────────────────────────┐             │              
 │                                               │             │              
 │  MarketDataEvent Creation                     │──────────────              
 │                                               │                            
 └───────────────────────────────────────────────┘                            
 

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              LIVE TRADING ARCHITECTURE                       │
└─────────────────────────────────────────────────────────────────────────────┘
                                                                        
 ┌────────────────┐         ┌────────────────┐        ┌────────────────┐     
 │                │         │                │        │                │     
 │  LiveEngine    │◄────────┤  EventManager  │◄───────┤  TradingEngine │     
 │                │         │                │        │                │     
 └────────┬───────┘         └────────────────┘        └────────────────┘     
          │                                                    ▲              
          │                                                    │              
          ▼                                                    │              
 ┌────────────────┐         ┌────────────────┐        ┌───────┴───────┐     
 │                │         │                │        │                │     
 │  MarketDataFeed├────────►│  FinvasiaFeed  │        │  Strategies   │     
 │                │         │                │        │                │     
 └────────┬───────┘         └────────┬───────┘        └────────────────┘     
          │                          │                        ▲              
          │                          │                        │              
          ▼                          ▼                        │              
 ┌────────────────┐         ┌────────────────┐       ┌───────┴───────┐      
 │                │         │                │       │                │      
 │  FinvasiaBroker├────────►│  NorenApi      │       │  MarketData   │      
 │                │         │                │       │  Manager       │      
 └────────────────┘         └────────┬───────┘       └────────────────┘      
                                     │                       ▲               
                                     │                       │               
                                     ▼                       │               
                            ┌────────────────┐               │               
                            │                │               │               
                            │  Websocket     ├───────────────┘               
                            │  Feed          │                               
                            │                │                               
                            └────────────────┘                               
```

**Key Interactions**:

1. **LiveEngine Initialization**:
   - LiveEngine extends TradingEngine with live-specific capabilities
   - It initializes the MarketDataFeed with broker settings
   - It configures persistence based on config

2. **MarketData Flow**:
   1. FinvasiaFeed connects to Finvasia API and establishes WebSocket
   2. Market data comes in via WebSocket
   3. FinvasiaFeed converts ticks to MarketDataEvents
   4. Events are sent to EventManager
   5. MarketDataManager receives events via subscription
   6. Strategies receive events via subscription or through MarketDataManager
   7. If persistence is enabled, ticks are stored to disk periodically

3. **Order Flow**:
   1. Strategies generate SignalEvents based on market data
   2. TradingEngine converts signals to OrderEvents
   3. LiveEngine routes OrderEvents to FinvasiaBroker
   4. FinvasiaBroker sends orders to the market via NorenApi
   5. Fill confirmations come back via WebSocket
   6. Fill events update positions in the PositionManager

4. **Configuration Chain**:
   - Config file is loaded by TradingEngine
   - LiveEngine accesses broker-specific config
   - MarketDataFeed reads feed_type and other settings
   - FinvasiaFeed is configured with credentials and WebSocket settings
   - Persistence is enabled based on config settings

## Additional Documentation

### FinvasiaFeed Persistence Features

The FinvasiaFeed class provides built-in persistence capabilities:

1. **In-Memory Storage**: 
   - Each instrument's recent ticks are stored in memory
   - Configurable limit on number of ticks per symbol
   - Efficient data structure for quick access

2. **Disk-Based Persistence**:
   - CSV file format for simplicity and compatibility
   - One file per symbol per day for easy organization
   - Configurable persistence interval
   - Automatic file creation and management

3. **Configuration Options**:
   - `enable_persistence(enabled, interval, path)`: Turn persistence on/off and configure it
   - `set_max_ticks_in_memory(max_ticks)`: Control memory usage
   - `get_historical_ticks(symbol, count)`: Retrieve recent ticks from memory

### Integration Points

1. **LiveEngine to MarketDataFeed**:
   - LiveEngine creates and configures MarketDataFeed
   - Passes instrument list, broker instance, and event manager
   - Configures persistence based on config file

2. **MarketDataFeed to FinvasiaFeed**:
   - MarketDataFeed creates FinvasiaFeed with proper credentials
   - Handles feed type selection (websocket, rest, simulated, finvasia_ws)
   - Routes market data events from feed to broker and event manager

3. **FinvasiaFeed to NorenApi**:
   - FinvasiaFeed uses NorenApi for authentication and data fetching
   - Handles WebSocket initialization and maintenance
   - Maps between trading symbols and exchange tokens

By implementing this architecture, you'll have a robust market data pipeline that efficiently captures, processes, and persists Finvasia market data while integrating smoothly with your trading engine.
