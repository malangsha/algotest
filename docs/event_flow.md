# Event Flow in the AlgoTrading Framework

This document describes the expected flow of events in the AlgoTrading framework. Understanding this flow is crucial for developers to ensure that components interact correctly and events propagate as expected.

## Event Types

The framework uses various event types to represent different stages in the trading process:

- `SIGNAL`: Trading signals generated by strategies
- `ORDER`: Order creation, updates, and status changes
- `EXECUTION`: Execution attempts (when an order is submitted to the broker)
- `FILL`: Order fills (complete or partial)
- `POSITION`: Position updates (resulting from fills)
- `ACCOUNT`: Account updates (balance, equity, etc.)
- `MARKET_DATA`: Market data updates (prices, quotes, etc.)

## Standard Event Flow

The typical flow of events in a trading operation follows this sequence:

1. **Strategy → Signal**: A strategy generates a `SIGNAL` event with trading intent
2. **Signal → Order**: The `OrderManager` processes the signal and creates an `ORDER` event
3. **Order → Execution**: The order is submitted to the broker, generating an `EXECUTION` event
4. **Execution → Fill**: When the broker executes the order, a `FILL` event is generated
5. **Fill → Position**: The `PositionManager` processes the fill and updates the position
6. **Position → Account**: The `Portfolio` updates the account based on position changes

```
Strategy → SIGNAL → OrderManager → ORDER → Broker → FILL → PositionManager → POSITION → Portfolio → ACCOUNT
                                      ↓
                                 EXECUTION
```

## Event Monitoring

The event flow is monitored by the `EventFlowMonitor` component, which:

- Tracks expected event chains (e.g., a `SIGNAL` should lead to an `ORDER`)
- Detects broken chains (e.g., if a `SIGNAL` doesn't result in an `ORDER`)
- Measures completion times for event chains
- Provides diagnostics for troubleshooting

## Common Flow Issues

Here are common issues that can break the event flow:

1. **Missing Subscribers**: If a component isn't subscribed to an event type, it won't receive those events.
2. **Validation Failures**: Events with missing required fields will be rejected.
3. **Error Handling**: Uncaught exceptions in event handlers can break the chain.
4. **Order Rejections**: The broker may reject orders, which should be properly handled.
5. **Event Queue Full**: If the event queue fills up, events may be dropped.

## Troubleshooting

When diagnosing event flow issues:

1. Check if the `EventManager` is started (`event_manager.start()`)
2. Verify that components are correctly subscribed to events
3. Use `event_manager.get_flow_monitor_diagnostics()` to get information about broken chains
4. Check `event_manager.get_error_history()` for errors in event processing
5. Ensure all required event fields are populated correctly
6. Look for events with incorrect parameter types (e.g., strings vs. enums)

## Best Practices

1. **Always validate events**: Use the `validate()` method before publishing
2. **Standardize parameters**: Use enums where appropriate and handle both string and enum values
3. **Handle errors gracefully**: Catch exceptions in event handlers
4. **Log important events**: Log key events at appropriate levels (INFO for normal, WARNING for issues)
5. **Monitor event flows**: Use the flow monitor to detect broken chains
6. **Use proper typed objects**: Use the appropriate event class for each event type

## Example Event Chain

Here's an example of a complete event chain for a buy order:

1. Strategy generates `SignalEvent(type=ENTRY, side=BUY, symbol="AAPL", quantity=10)`
2. OrderManager creates `OrderEvent(side=BUY, symbol="AAPL", quantity=10, status=PENDING)`
3. OrderManager updates `OrderEvent(status=SUBMITTED)`
4. Broker sends `FillEvent(symbol="AAPL", quantity=10, price=150.0)`
5. PositionManager creates `PositionEvent(symbol="AAPL", quantity=10, average_price=150.0)`
6. Portfolio updates `AccountEvent(equity=new_equity, positions_value=positions_value)`

Each component in this chain is responsible for handling specific event types and generating appropriate follow-up events. 